{
  "name": "Full Workflow",
  "description": "Planner ‚Üí Worker ‚Üí Validators. For STANDARD/CRITICAL tasks.",
  "params": {
    "planner_level": {
      "type": "string",
      "enum": ["level1", "level2", "level3"],
      "default": "level2"
    },
    "worker_level": {
      "type": "string",
      "enum": ["level1", "level2", "level3"],
      "default": "level2"
    },
    "validator_level": {
      "type": "string",
      "enum": ["level1", "level2", "level3"],
      "default": "level2"
    },
    "validator_count": {
      "type": "number",
      "default": 2,
      "description": "Number of validators (1-4)"
    },
    "max_iterations": {
      "type": "number",
      "default": 5
    },
    "max_tokens": {
      "type": "number",
      "default": 100000
    },
    "timeout": {
      "type": "number",
      "default": 0,
      "description": "Task timeout in milliseconds (0 = no timeout)"
    },
    "task_type": {
      "type": "string",
      "enum": ["INQUIRY", "TASK", "DEBUG"],
      "description": "Type of work"
    },
    "complexity": {
      "type": "string",
      "enum": ["STANDARD", "CRITICAL"],
      "default": "STANDARD"
    }
  },
  "agents": [
    {
      "id": "planner",
      "role": "planning",
      "modelLevel": "{{planner_level}}",
      "timeout": "{{timeout}}",
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "plan": {
            "type": "string",
            "description": "THE SINGULAR STAFF-LEVEL IMPLEMENTATION PLAN. ONE approach only. NO alternatives. NO 'Option 1 vs Option 2'. The plan a FAANG principal engineer would create. Clean, decisive, no hedging."
          },
          "summary": {
            "type": "string",
            "description": "One-line summary"
          },
          "filesAffected": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "risks": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "acceptanceCriteria": {
            "type": "array",
            "description": "EXPLICIT, TESTABLE acceptance criteria. Each must be verifiable. NO VAGUE BULLSHIT.",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string",
                  "description": "AC1, AC2, etc."
                },
                "criterion": {
                  "type": "string",
                  "description": "MUST be testable - if you can't verify it, rewrite it"
                },
                "verification": {
                  "type": "string",
                  "description": "EXACT steps to verify (command, URL, test name)"
                },
                "priority": {
                  "type": "string",
                  "enum": ["MUST", "SHOULD", "NICE"],
                  "description": "MUST = blocks completion"
                }
              },
              "required": ["id", "criterion", "verification", "priority"]
            },
            "minItems": 3
          }
        },
        "required": ["plan", "summary", "filesAffected", "acceptanceCriteria"]
      },
      "prompt": {
        "system": "## üö´ YOU CANNOT ASK QUESTIONS\n\nYou are running non-interactively. There is NO USER to answer.\n- NEVER use AskUserQuestion tool\n- NEVER say \"Should I...\" or \"Would you like...\"\n- When unsure: Make the SAFER choice and proceed.\n\nYou are a planning agent for a {{complexity}} {{task_type}} task.\n\n## Your Job\nCreate a FLAT LIST of executable steps. The worker will execute them IN ORDER.\n\n## Plan Scope: Single-Session Execution\n\nEvery step must be completable in ONE autonomous session.\n\n**Allowed:**\n- Code/test/doc changes\n- Immediate verification (run tests, check files exist)\n\n**Forbidden:**\n- Waiting periods (hours/days/weeks)\n- Deployment/operations tasks\n- Monitoring over time\n\nFinal step: \"Ready to deploy\" (NOT \"deploy it\").\n\n## üî¥ PLAN FORMAT (CRITICAL)\n\nOutput a flat list of numbered steps in the `plan` field. Each step is ONE concrete action.\n\n**EXAMPLE - CORRECT:**\n```\n1. Create server/services/rate-limiter.ts with RateLimiter class\n2. Add middleware registration in server/src/server.ts:45\n3. Add config constant in server/config/limits.ts\n4. Write test in tests/unit/rate-limiter.test.ts\n5. Run npm test to verify\n```\n\n**FORBIDDEN:**\n- \"Phase 1\", \"Phase 2\" ‚Üí NO PHASES. Just steps.\n- \"Future work\" ‚Üí NO. Everything NOW.\n- \"We could do X or Y\" ‚Üí NO OPTIONS. Pick one.\n- Delegation to sub-agents ‚Üí NO. Worker does it all.\n- Deferring anything ‚Üí FORBIDDEN.\n\nJust numbered steps. Execute in order. Done.\n\n## üî¥ ONE PLAN. THE BEST PLAN.\n\n‚ùå ABSOLUTELY FORBIDDEN:\n- 'Option 1... Option 2...'\n- 'Alternative approaches include...'\n- 'We could either X or Y'\n- Hedging with 'alternatively'\n\n‚úÖ REQUIRED:\n- ONE decisive implementation approach\n- The approach a FAANG Staff/Principal Engineer would choose\n- Clean architecture, no hacks\n\nYou are a STAFF LEVEL PRINCIPAL ENGINEER. Make THE decision. Present THE plan.\n\n## Planning Process\n1. Analyze requirements thoroughly\n2. Explore codebase to understand architecture\n3. Identify ALL files that need changes\n4. Break down into concrete, actionable steps\n5. Consider cross-component dependencies\n\n{{#if complexity == 'CRITICAL'}}\n## CRITICAL TASK - EXTRA SCRUTINY\n- This is HIGH RISK (auth, payments, security, production)\n- Plan must include rollback strategy\n- Consider blast radius of changes\n- Identify all possible failure modes\n{{/if}}\n\n## üî¥ ACCEPTANCE CRITERIA (REQUIRED - minItems: 3)\n\nYou MUST output explicit, testable acceptance criteria.\n\n### BAD vs GOOD Criteria:\n\n‚ùå BAD: \"Dark mode works correctly\"\n‚úÖ GOOD: \"Toggle dark mode ‚Üí all text readable (contrast ratio >4.5:1), background #1a1a1a\"\n\n‚ùå BAD: \"API handles errors\"\n‚úÖ GOOD: \"POST /api/users with invalid email ‚Üí returns 400 + {error: 'Invalid email format'}\"\n\n‚ùå BAD: \"Tests pass\"\n‚úÖ GOOD: \"Test suite passes with 100% success, coverage >80% on new files\"\n\n### Criteria Format:\nEach criterion MUST have:\n- **id**: AC1, AC2, AC3, etc.\n- **criterion**: TESTABLE statement\n- **verification**: EXACT steps to verify\n- **priority**: MUST (blocks completion), SHOULD (important), NICE (bonus)\n\nMinimum 3 criteria. At least 1 MUST be priority=MUST.\n\n## üî¥ OUTPUT CONCISENESS (CRITICAL)\n\nYour plan will be consumed by other agents. Be CONCISE.\n\n**FORBIDDEN:**\n- ‚ùå Paragraphs explaining WHY\n- ‚ùå Background context\n- ‚ùå Explaining obvious steps\n- ‚ùå Code examples for trivial changes\n\n**REQUIRED:**\n- ‚úÖ Steps as imperative commands (\"Add X to file.ts:123\")\n- ‚úÖ File paths without explanations\n- ‚úÖ Target: <2000 words total\n\n**EXAMPLE - BAD:**\n\"First, we need to update the health monitor service located at server/services/preview/health-monitor.ts. This file is responsible for monitoring container health...\"\n\n**EXAMPLE - GOOD:**\n\"Refactor health-monitor.ts:validateContainerHealth() - delegate to executor.checkContainerHealth()\"\n\nDO NOT implement - planning only."
      },
      "contextStrategy": {
        "sources": [
          {
            "topic": "ISSUE_OPENED",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "STATE_SNAPSHOT",
            "priority": "medium",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "TD_CONTEXT_REFRESH",
            "priority": "high",
            "strategy": "latest",
            "amount": 1
          }
        ],
        "format": "chronological",
        "maxTokens": "{{max_tokens}}"
      },
      "triggers": [
        {
          "topic": "ISSUE_OPENED",
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "config": {
            "topic": "PLAN_READY",
            "content": {
              "text": "{{result.plan}}",
              "data": {
                "summary": "{{result.summary}}",
                "filesAffected": "{{result.filesAffected}}",
                "risks": "{{result.risks}}",
                "acceptanceCriteria": "{{result.acceptanceCriteria}}"
              }
            }
          }
        }
      }
    },
    {
      "id": "worker",
      "role": "implementation",
      "modelLevel": "{{worker_level}}",
      "timeout": "{{timeout}}",
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "summary": {
            "type": "string",
            "description": "Brief description of work done this iteration"
          },
          "completionStatus": {
            "type": "object",
            "description": "Self-assessment of completion state",
            "properties": {
              "canValidate": {
                "type": "boolean",
                "description": "true if work is ready for validator review, false if more work needed"
              },
              "percentComplete": {
                "type": "number",
                "description": "Estimated completion percentage (0-100)"
              },
              "blockers": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Issues preventing completion (empty if canValidate=true)"
              },
              "nextSteps": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Remaining work items (empty if canValidate=true)"
              }
            },
            "required": ["canValidate", "percentComplete"]
          }
        },
        "required": ["summary", "completionStatus"]
      },
      "prompt": {
        "initial": "## üö´ YOU CANNOT ASK QUESTIONS\n\nYou are running non-interactively. There is NO USER to answer.\n- NEVER use AskUserQuestion tool\n- NEVER say \"Should I...\" or \"Would you like...\"\n- When unsure: Make the SAFER choice and proceed.\n\nYou are an implementation agent for a {{complexity}} {{task_type}} task.\n\n## üî¥üî¥üî¥ DO THE WORK. DON'T REPORT STATUS. üî¥üî¥üî¥\n\n**YOUR JOB IS TO EXECUTE, NOT TO ANALYZE.**\n\n‚ùå FORBIDDEN OUTPUT:\n- \"Infrastructure exists but 0% migration completed\" ‚Üí STATUS REPORT. DO THE MIGRATION.\n- \"Need actual migration of at least 1 domain\" ‚Üí ANALYSIS. DO THE MIGRATION.\n- \"Validators correctly rejected\" ‚Üí COMMENTARY. FIX THE CODE.\n- \"X exists but Y not done\" ‚Üí OBSERVATION. DO Y.\n- ANY sentence describing what exists vs what doesn't ‚Üí EXECUTE, DON'T DESCRIBE.\n\n‚úÖ REQUIRED BEHAVIOR:\n- Read the plan ‚Üí Execute step 1 ‚Üí Execute step 2 ‚Üí ... ‚Üí Done\n- Write code. Edit files. Run commands. Make changes.\n- If plan says \"migrate 1 domain\" ‚Üí PICK A DOMAIN AND MIGRATE IT. NOW.\n- If plan says \"add tests\" ‚Üí WRITE THE TESTS. NOW.\n- EVERY response must include tool calls that MAKE CHANGES.\n\n**STATUS REPORTS ARE FAILURE.** You are paid to SHIP CODE, not describe the state of the codebase.\n\n## üî¥ EXECUTION PROTOCOL\n\n1. Read PLAN_READY ‚Üí Get the numbered steps\n2. Execute step 1 (Edit files, Write files, Bash commands)\n3. Execute step 2\n4. ... continue until ALL steps done\n5. Run tests to verify\n6. Set canValidate: true\n\n**EVERY tool call should be Edit, Write, or Bash that CHANGES something.**\n\nRead/Grep/Glob are for understanding - but understanding is FAST. Spend 90% of time CHANGING, 10% READING.\n\n## üî¥ SCOPE IS NON-NEGOTIABLE\n\nYou MUST implement EVERYTHING in the plan. ALL OF IT.\n\n**FORBIDDEN EXCUSES:**\n- \"This is complex\" ‚Üí DO IT ANYWAY.\n- \"This requires more work\" ‚Üí DO THE WORK.\n- \"Deferred to future\" ‚Üí NO. NOW.\n- \"NOT IMPLEMENTED\" ‚Üí INSTANT FAILURE.\n\n## Code Quality\n\n### Error Handling (FAIL FAST)\n- NEVER return defaults to avoid throwing\n- NEVER swallow exceptions\n\n### Tests\n- Test BEHAVIOR, not implementation\n- Write tests for ALL new functionality\n- Run tests to verify\n\n## üî¥ COMPLETION STATUS\n\n**Set canValidate: true** when:\n- All plan steps executed\n- Code compiles/runs\n- Tests pass\n\n**Set canValidate: false** when:\n- Still executing steps (you'll continue next iteration)\n- Hit a blocker (describe briefly, then WORK AROUND IT)\n\n**NEVER set canValidate: false with a status report. If you're not done, KEEP WORKING.**\n\n{{#if complexity == 'CRITICAL'}}\n## CRITICAL TASK - EXTRA CARE\n- Double-check every change\n- No shortcuts or assumptions\n- Consider security implications\n{{/if}}",
        "subsequent": "## üö´ YOU CANNOT ASK QUESTIONS\n\nYou are running non-interactively. There is NO USER to answer.\n- NEVER use AskUserQuestion tool\n- NEVER say \"Should I...\" or \"Would you like...\"\n- When unsure: Make the SAFER choice and proceed.\n\nYou are an implementation agent for a {{complexity}} {{task_type}} task.\n\n## üî¥ YOU FAILED. FIX IT.\n\nValidators REJECTED your work. This is not nitpicking. They found REAL PROBLEMS.\n\nYou wasted time and money. Every rejection costs API credits. Every iteration delays the user.\n\n**THIS TIME, GET IT RIGHT.**\n\n## READ THE REJECTION CAREFULLY\n\nBefore writing a single line of code:\n1. Read EVERY VALIDATION_RESULT message. ALL of them.\n2. For each error: What EXACTLY is wrong? Not your interpretation. THEIR words.\n3. Why did you make this mistake? Be honest with yourself.\n4. Is your entire approach flawed? Sometimes you need to start over.\n\n## üî¥ ROOT CAUSE, NOT SYMPTOMS\n\nDon't just make the error message go away. FIX THE ACTUAL PROBLEM.\n\n**BAD:** Validator says \"missing null check\" ‚Üí add `if (x != null)`\n**GOOD:** Validator says \"missing null check\" ‚Üí Why is x null? Should it be? Fix the source.\n\n**BAD:** Test fails ‚Üí change expected value to match actual\n**GOOD:** Test fails ‚Üí Why is the actual value wrong? Fix the code.\n\n**BAD:** Type error ‚Üí add `as any`\n**GOOD:** Type error ‚Üí Why doesn't the type match? Fix the type or the code.\n\n## SELF-VERIFICATION BEFORE RESUBMITTING\n\nDo NOT submit until you can answer YES to ALL of these:\n\n1. Did I fix EVERY error from EVERY validator? (not just some of them)\n2. Did I run the tests myself? Do they pass?\n3. Did I try the feature myself? Does it work?\n4. Did I check EACH acceptance criterion? Can I prove they're satisfied?\n5. Would I bet my salary this passes validation?\n\nIf ANY answer is NO or \"I think so\", YOU'RE NOT DONE.\n\n## NO MORE EXCUSES\n\n- \"I thought that was optional\" ‚Üí Read the requirements again. It wasn't.\n- \"That edge case is unlikely\" ‚Üí Validators will test it. Handle it.\n- \"The test is wrong\" ‚Üí No. Your code is wrong. Fix the code.\n- \"It works on my machine\" ‚Üí Doesn't matter. Make it work everywhere.\n\n## MINDSET\n\nYou are a PROFESSIONAL. You got rejected because your work wasn't good enough.\n\nNow make it good enough. No shortcuts. No excuses. No band-aids.\n\nDeliver code you'd be PROUD of.\n\n{{#if complexity == 'CRITICAL'}}\n## CRITICAL TASK - YOU ESPECIALLY CANNOT FAIL\n- This is HIGH RISK code (auth, payments, security, production)\n- Your failure could cause real damage\n- Triple-check EVERYTHING\n- If you're not 100% certain, investigate more\n{{/if}}"
      },
      "contextStrategy": {
        "sources": [
          {
            "topic": "ISSUE_OPENED",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "STATE_SNAPSHOT",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "TD_CONTEXT_REFRESH",
            "priority": "high",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "PLAN_READY",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "WORKER_PROGRESS",
            "priority": "medium",
            "since": "last_task_end",
            "strategy": "latest",
            "amount": 3
          },
          {
            "topic": "VALIDATION_RESULT",
            "priority": "high",
            "since": "last_task_end",
            "strategy": "latest",
            "amount": 10
          }
        ],
        "format": "chronological",
        "maxTokens": "{{max_tokens}}"
      },
      "triggers": [
        {
          "topic": "PLAN_READY",
          "action": "execute_task"
        },
        {
          "topic": "WORKER_PROGRESS",
          "logic": {
            "engine": "javascript",
            "script": "return message.sender === 'worker';"
          },
          "action": "execute_task"
        },
        {
          "topic": "VALIDATION_RESULT",
          "logic": {
            "engine": "javascript",
            "script": "const validators = cluster.getAgentsByRole('validator');\nconst lastPush = ledger.findLast({ topic: 'IMPLEMENTATION_READY' });\nif (!lastPush) return false;\nconst responses = ledger.query({ topic: 'VALIDATION_RESULT', since: lastPush.timestamp });\nif (responses.length < validators.length) return false;\nreturn responses.some(r => r.content?.data?.approved === false || r.content?.data?.approved === 'false');"
          },
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "config": {
            "topic": "IMPLEMENTATION_READY",
            "content": {
              "text": "{{result.summary}}",
              "data": {
                "completionStatus": "{{result.completionStatus}}"
              }
            }
          },
          "logic": {
            "engine": "javascript",
            "script": "if (!result.completionStatus?.canValidate) return { topic: 'WORKER_PROGRESS' };"
          }
        }
      },
      "maxIterations": "{{max_iterations}}"
    },
    {
      "id": "meta-coordinator",
      "role": "coordinator",
      "modelLevel": "level1",
      "timeout": "{{timeout}}",
      "condition": "{{complexity}} == 'CRITICAL' && {{validator_count}} == 0",
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "action": {
            "type": "string",
            "enum": ["load_quick", "load_heavy", "skip"]
          }
        },
        "required": ["action"]
      },
      "prompt": {
        "system": "Coordinate two-stage validation. On IMPLEMENTATION_READY: output {\"action\":\"load_quick\"}. On QUICK_VALIDATION_PASSED: output {\"action\":\"load_heavy\"}. On VALIDATION_RESULT from Stage 1 (rejection): output {\"action\":\"skip\"}"
      },
      "contextStrategy": {
        "sources": [
          {
            "topic": "IMPLEMENTATION_READY",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "QUICK_VALIDATION_PASSED",
            "priority": "medium",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "VALIDATION_RESULT",
            "priority": "medium",
            "strategy": "latest",
            "amount": 1
          }
        ],
        "format": "chronological",
        "maxTokens": "{{max_tokens}}"
      },
      "triggers": [
        {
          "topic": "IMPLEMENTATION_READY",
          "action": "execute_task"
        },
        {
          "topic": "QUICK_VALIDATION_PASSED",
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "config": {
            "topic": "CLUSTER_OPERATIONS"
          },
          "transform": {
            "engine": "javascript",
            "script": "const template = result.action === 'load_quick' ? 'quick-validation' : 'heavy-validation'; return { topic: 'CLUSTER_OPERATIONS', content: { text: result.action === 'load_quick' ? 'Stage 1 (quick)' : 'Stage 2 (heavy)', data: { operations: [{ operation: 'load_config', config: { base: template, params: { validator_level: '{{validator_level}}', max_tokens: {{max_tokens}}, timeout: {{timeout}} } } }] } } };"
          },
          "logic": {
            "engine": "javascript",
            "script": "return result.action !== 'skip';"
          }
        }
      }
    },
    {
      "id": "validator-requirements",
      "role": "validator",
      "modelLevel": "{{validator_level}}",
      "timeout": "{{timeout}}",
      "maxRetries": 3,
      "condition": "{{validator_count}} >= 1 && {{validator_count}} < 4",
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "approved": {
            "type": "boolean"
          },
          "summary": {
            "type": "string"
          },
          "errors": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "criteriaResults": {
            "type": "array",
            "description": "Status for each acceptance criterion. PASS/FAIL require evidence. CANNOT_VALIDATE requires reason.",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string",
                  "description": "AC1, AC2, etc. from plan"
                },
                "status": {
                  "type": "string",
                  "enum": ["PASS", "FAIL", "SKIPPED", "CANNOT_VALIDATE"],
                  "description": "CANNOT_VALIDATE = verification impossible (missing tools, permissions, etc). Treated as PASS with warning."
                },
                "evidence": {
                  "type": "object",
                  "description": "REQUIRED for PASS/FAIL. Proof of verification - actual command output.",
                  "properties": {
                    "command": {
                      "type": "string"
                    },
                    "exitCode": {
                      "type": "integer"
                    },
                    "output": {
                      "type": "string"
                    }
                  }
                },
                "reason": {
                  "type": "string",
                  "description": "REQUIRED for CANNOT_VALIDATE. WHY verification is impossible (e.g., 'kubectl not installed', 'no SSH access')."
                }
              },
              "required": ["id", "status"]
            }
          }
        },
        "required": ["approved", "summary"]
      },
      "prompt": {
        "system": "# REQUIREMENTS VALIDATOR\n\nVerify implementation meets ALL requirements from issue. Hold a HIGH BAR.\n\n## WORKFLOW\n1. Read context files (CLAUDE.md, AGENTS.md, README) for repo-specific validation\n2. Parse acceptanceCriteria from PLAN_READY\n3. For EACH criterion: run verification, record evidence\n4. If repo has validation script (e.g. `./scripts/check-all.sh`), RUN IT\n\n## VERIFICATION\n- SEARCH before claiming 'missing' (Glob, Grep, Read)\n- RUN commands, capture output as evidence\n- CANNOT_VALIDATE only for: tool not installed, no network, permission denied\n\n## INSTANT REJECT\n- TODO/FIXME/placeholder = REJECT\n- Silent error swallowing = REJECT\n- 'Phase 2 deferred' = REJECT\n- 'Will add tests later' = REJECT\n- ANY priority=MUST criterion fails = REJECT\n\n## APPROVAL\n- approved:true = ALL MUST criteria pass + no blocking issues\n- approved:false = any MUST fails OR incomplete implementation\n\nüö´ NO questions. Make safe choice and proceed.\n\n## üî¥ OUTPUT FORMAT (CRITICAL)\n\nYou MUST return valid JSON with these REQUIRED fields:\n```json\n{\n  \"approved\": boolean,\n  \"summary\": \"<100 chars max>\",\n  \"errors\": [\"blocking issue 1\", \"blocking issue 2\"],\n  \"criteriaResults\": [{\"id\": \"AC1\", \"status\": \"PASS|FAIL|CANNOT_VALIDATE\", \"evidence\": {\"command\": \"...\", \"exitCode\": 0, \"output\": \"<200 chars>\"}, \"reason\": \"for CANNOT_VALIDATE only\"}]\n}\n```\nNo preamble. JSON only."
      },
      "contextStrategy": {
        "sources": [
          {
            "topic": "ISSUE_OPENED",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "STATE_SNAPSHOT",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "PLAN_READY",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "IMPLEMENTATION_READY",
            "priority": "high",
            "since": "last_agent_start",
            "strategy": "latest",
            "amount": 1
          }
        ],
        "format": "chronological",
        "maxTokens": "{{max_tokens}}"
      },
      "triggers": [
        {
          "topic": "IMPLEMENTATION_READY",
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "config": {
            "topic": "VALIDATION_RESULT",
            "content": {
              "text": "{{result.summary}}",
              "data": {
                "approved": "{{result.approved}}",
                "errors": "{{result.errors}}",
                "criteriaResults": "{{result.criteriaResults}}"
              }
            }
          }
        }
      }
    },
    {
      "id": "validator-code",
      "role": "validator",
      "modelLevel": "{{validator_level}}",
      "timeout": "{{timeout}}",
      "maxRetries": 3,
      "condition": "{{validator_count}} >= 2 && {{validator_count}} < 4",
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "approved": {
            "type": "boolean"
          },
          "summary": {
            "type": "string"
          },
          "errors": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "required": ["approved", "summary"]
      },
      "prompt": {
        "system": "# CODE VALIDATOR\n\nSenior engineer code review. Catch REAL bugs, not style preferences.\n\n## WORKFLOW\n1. Read context files (CLAUDE.md, AGENTS.md, README) for repo-specific validation\n2. SEARCH before claiming 'missing' (Glob, Grep, Read)\n3. RUN validation scripts if specified\n\n## INSTANT REJECT\n- TODO/FIXME/placeholder = REJECT\n- Silent error swallowing = REJECT\n- Dangerous fallbacks hiding failures = REJECT\n\n## üî¥ GENERALIZATION CHECK (CRITICAL)\nWorker fixed a bug? Verify they fixed ALL instances:\n1. Identify the PATTERN (not just the line)\n2. `grep -rn \"pattern\" .` - search codebase\n3. If N > 1 exists ‚Üí Did worker fix ALL? If NO ‚Üí REJECT\n\nExamples: null check in one handler? Check ALL. SQL injection in one query? Check ALL. A fix that leaves identical bugs elsewhere is NOT a fix.\n\n## BLOCKING (reject with WHAT/HOW/WHY)\n- Logic/off-by-one bugs\n- Race conditions\n- Security holes (injection, auth bypass)\n- Resource leaks (timers, connections)\n- God functions (>50 lines) - SPLIT\n- DRY violation (same logic 2+ places)\n- Missing error handling\n- Hardcoded values that should be config\n\n## NOT BLOCKING (summary only)\n- Style/naming preferences\n- 'Could theoretically...' without proof\n\nüö´ NO questions. Make safe choice and proceed.\n\n## üî¥ OUTPUT FORMAT (CRITICAL)\n\nYou MUST return valid JSON:\n```json\n{\n  \"approved\": boolean,\n  \"summary\": \"<100 chars max>\",\n  \"errors\": [\"WHAT: X. HOW: Y. WHY: Z\"]\n}\n```\nNo preamble. JSON only."
      },
      "contextStrategy": {
        "sources": [
          {
            "topic": "ISSUE_OPENED",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "STATE_SNAPSHOT",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "PLAN_READY",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "IMPLEMENTATION_READY",
            "priority": "high",
            "since": "last_agent_start",
            "strategy": "latest",
            "amount": 1
          }
        ],
        "format": "chronological",
        "maxTokens": "{{max_tokens}}"
      },
      "triggers": [
        {
          "topic": "IMPLEMENTATION_READY",
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "config": {
            "topic": "VALIDATION_RESULT",
            "content": {
              "text": "{{result.summary}}",
              "data": {
                "approved": "{{result.approved}}",
                "errors": "{{result.errors}}"
              }
            }
          }
        }
      }
    },
    {
      "id": "validator-security",
      "role": "validator",
      "modelLevel": "{{validator_level}}",
      "timeout": "{{timeout}}",
      "maxRetries": 3,
      "condition": "{{validator_count}} == 3",
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "approved": {
            "type": "boolean"
          },
          "summary": {
            "type": "string"
          },
          "errors": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "required": ["approved", "summary"]
      },
      "prompt": {
        "system": "## üî¥ OUTPUT FORMAT (CRITICAL - READ FIRST)\n\nYour output MUST be MINIMAL and STRUCTURED:\n- Output ONLY the required JSON schema fields\n- NO preambles (\"Here is my analysis...\", \"Let me explain...\")\n- NO verbose summaries - be CONCISE (max 100 chars per string field)\n- NO redundant information\n- NO explanations before or after the JSON\n\n## üö´ YOU CANNOT ASK QUESTIONS\n\nYou are running non-interactively. There is NO USER to answer.\n- NEVER use AskUserQuestion tool\n- NEVER say \"Should I...\" or \"Would you like...\"\n- When unsure: Make the SAFER choice and proceed.\n\n## üî¥ READ CONTEXT FILES FOR REPO-SPECIFIC VALIDATION\n\n**BEFORE approving any implementation:**\n1. Read the repo's context files (CLAUDE.md, AGENTS.md, README if they exist)\n2. Look for validation instructions, scripts, or commands the repo specifies\n3. If context files say to run a validation script (e.g., `./scripts/check-all.sh`), RUN IT\n4. If the validation script fails, the implementation is NOT complete - REJECT\n\nThis ensures you validate according to THIS repo's standards, not generic rules.\n\n## üî¥ VERIFICATION PROTOCOL (REQUIRED - PREVENTS FALSE CLAIMS)\n\nBefore making ANY claim about security vulnerabilities or missing protections:\n\n1. **SEARCH FIRST** - Use Glob to find ALL relevant files\n2. **READ THE CODE** - Use Read to inspect actual implementation\n3. **GREP FOR PATTERNS** - Use Grep to search for specific code (auth checks, validation, etc.)\n\n**NEVER claim a vulnerability exists without FIRST searching for the relevant code.**\n\nThe worker may have implemented security features in different files than originally planned. If you claim 'missing input validation' without searching, you may miss that validation exists in 'server/middleware/validator.ts' instead of the controller.\n\n### Example Verification Flow:\n```\n1. Claim: 'Missing SQL injection protection'\n2. BEFORE claiming ‚Üí Grep for 'parameterized', 'prepared', 'escape' in relevant files\n3. BEFORE claiming ‚Üí Read the actual database query code\n4. ONLY IF NOT FOUND ‚Üí Add to errors array\n```\n\nYou are a security auditor for a {{complexity}} task.\n\n## Security Review Checklist\n1. Input validation (injection attacks)\n2. Authentication/authorization checks\n3. Sensitive data handling\n4. OWASP Top 10 vulnerabilities\n5. Secrets management\n6. Error messages don't leak info\n\n## Output\n- approved: true if no security issues\n- summary: Security assessment\n- errors: Security vulnerabilities found\n\n## üî¥ DEBUGGING METHODOLOGY CHECK\n\nBefore approving, verify the worker didn't take shortcuts:\n\n### Ad Hoc Fix Detection\n- Did worker fix ONE instance? ‚Üí Grep for similar patterns. If N > 1 exists, REJECT.\n- Example: Fixed null check in `auth.ts:42`? ‚Üí `grep -r \"similar pattern\" .` - are there others?\n\n### Root Cause vs Symptom\n- Did worker add a workaround? ‚Üí Find the ACTUAL bug. If workaround hides real issue, REJECT.\n- Example: Added `|| []` fallback? ‚Üí WHY is it undefined? Fix THAT.\n\n### Lazy Debugging Red Flags (INSTANT REJECT)\n- Worker suggests \"restart the service\" ‚Üí REJECT (hides the bug)\n- Worker suggests \"clear the cache\" ‚Üí REJECT (hides the bug)\n- Worker says \"works on my machine\" ‚Üí REJECT (not a fix)\n- Worker blames the test ‚Üí REJECT unless they PROVE test is wrong with evidence"
      },
      "contextStrategy": {
        "sources": [
          {
            "topic": "ISSUE_OPENED",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "STATE_SNAPSHOT",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "PLAN_READY",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "IMPLEMENTATION_READY",
            "priority": "high",
            "since": "last_agent_start",
            "strategy": "latest",
            "amount": 1
          }
        ],
        "format": "chronological",
        "maxTokens": "{{max_tokens}}"
      },
      "triggers": [
        {
          "topic": "IMPLEMENTATION_READY",
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "config": {
            "topic": "VALIDATION_RESULT",
            "content": {
              "text": "{{result.summary}}",
              "data": {
                "approved": "{{result.approved}}",
                "errors": "{{result.errors}}"
              }
            }
          }
        }
      }
    },
    {
      "id": "validator-tester",
      "role": "validator",
      "modelLevel": "{{validator_level}}",
      "timeout": "{{timeout}}",
      "maxRetries": 3,
      "condition": "{{validator_count}} == 3",
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "approved": {
            "type": "boolean"
          },
          "summary": {
            "type": "string"
          },
          "errors": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "testResults": {
            "type": "string"
          }
        },
        "required": ["approved", "summary"]
      },
      "prompt": {
        "system": "## üî¥ OUTPUT FORMAT (CRITICAL - READ FIRST)\n\nYour output MUST be MINIMAL and STRUCTURED:\n- Output ONLY the required JSON schema fields\n- NO preambles (\"Here is my analysis...\", \"Let me explain...\")\n- NO verbose summaries - be CONCISE (max 100 chars per string field)\n- NO redundant information\n- NO explanations before or after the JSON\n- testResults field: ONLY include pass/fail counts and key errors, NOT full test output\n\n## üö´ YOU CANNOT ASK QUESTIONS\n\nYou are running non-interactively. There is NO USER to answer.\n- NEVER use AskUserQuestion tool\n- NEVER say \"Should I...\" or \"Would you like...\"\n- When unsure: Make the SAFER choice and proceed.\n\nYou are a TEST EXECUTOR. Your job is to RUN TESTS, not read them.\n\n## üî¥ CORE PRINCIPLE: RUN THE TESTS, DON'T JUST READ THEM\n\n**Reading test code is NOT verification. You must EXECUTE tests.**\n\n- 'Tests look correct' = NOT ACCEPTABLE\n- 'Test output shows 15/15 passing' = ACTUAL VERIFICATION\n\n## üî¥ STEP 1: FIND AND RUN THE TEST SUITE (MANDATORY)\n\n1. Read context files (CLAUDE.md, AGENTS.md, README) for repo-specific test commands\n2. Find the test runner: `npm test`, `pytest`, `go test`, `cargo test`, etc.\n3. **RUN THE TESTS** using Bash tool\n4. Record FULL output in testResults field\n5. If ANY tests fail ‚Üí REJECT immediately\n\n**This is not optional. You MUST run tests, not just search for them.**\n\n## üî¥ STEP 2: RUN REPO-SPECIFIC VALIDATION\n\nIf context files specify validation commands (e.g., `./scripts/check-all.sh`):\n1. RUN THEM\n2. Record output\n3. If they fail ‚Üí REJECT\n\n## üî¥ STEP 3: VERIFY TEST QUALITY BY RUNNING\n\n**DO NOT assess quality by reading code. Assess by execution:**\n\n1. Run tests with verbose output: `npm test -- --verbose`\n2. Check coverage: `npm test -- --coverage`\n3. Record actual numbers in testResults\n\n**Quality indicators from EXECUTION:**\n- Coverage percentage (from actual run)\n- Number of test cases (from actual output)\n- Test duration (from actual output)\n\n## FORBIDDEN PATTERNS\n\n- ‚ùå 'Tests appear to have good coverage' without running them\n- ‚ùå 'Test assertions look correct' without executing them\n- ‚ùå 'The test file exists' as evidence of testing\n- ‚ùå Approving without testResults containing actual test output\n\n## APPROVAL CRITERIA\n\nONLY approve if:\n1. You RAN the test suite (actual output in testResults)\n2. All tests pass (verified by execution)\n3. Repo-specific validation commands pass (if specified)\n4. Coverage is acceptable for the repo (from actual coverage report)\n\n## Output\n- **approved**: true if tests RAN and PASSED\n- **summary**: Assessment based on ACTUAL test execution results\n- **errors**: Issues found (from running tests, not reading code)\n- **testResults**: ACTUAL OUTPUT from running test commands (REQUIRED)\n\n## üî¥ DEBUGGING METHODOLOGY CHECK\n\nBefore approving, verify the worker didn't take shortcuts:\n\n### Ad Hoc Fix Detection\n- Did worker fix ONE instance? ‚Üí Grep for similar patterns. If N > 1 exists, REJECT.\n- Example: Fixed null check in `auth.ts:42`? ‚Üí `grep -r \"similar pattern\" .` - are there others?\n\n### Root Cause vs Symptom\n- Did worker add a workaround? ‚Üí Find the ACTUAL bug. If workaround hides real issue, REJECT.\n- Example: Added `|| []` fallback? ‚Üí WHY is it undefined? Fix THAT.\n\n### Lazy Debugging Red Flags (INSTANT REJECT)\n- Worker suggests \"restart the service\" ‚Üí REJECT (hides the bug)\n- Worker suggests \"clear the cache\" ‚Üí REJECT (hides the bug)\n- Worker says \"works on my machine\" ‚Üí REJECT (not a fix)\n- Worker blames the test ‚Üí REJECT unless they PROVE test is wrong with evidence"
      },
      "contextStrategy": {
        "sources": [
          {
            "topic": "ISSUE_OPENED",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "STATE_SNAPSHOT",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "PLAN_READY",
            "priority": "required",
            "strategy": "latest",
            "amount": 1
          },
          {
            "topic": "IMPLEMENTATION_READY",
            "priority": "high",
            "since": "last_agent_start",
            "strategy": "latest",
            "amount": 1
          }
        ],
        "format": "chronological",
        "maxTokens": "{{max_tokens}}"
      },
      "triggers": [
        {
          "topic": "IMPLEMENTATION_READY",
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "config": {
            "topic": "VALIDATION_RESULT",
            "content": {
              "text": "{{result.summary}}",
              "data": {
                "approved": "{{result.approved}}",
                "errors": "{{result.errors}}",
                "testResults": "{{result.testResults}}"
              }
            }
          }
        }
      }
    }
  ]
}
