{
  "name": "Two-Tier Conductor (Complexity Ã— TaskType)",
  "description": "Cost-optimized conductor: level1 junior for 2D classification (complexity + taskType), level2 senior for UNCERTAIN tasks. Routes to appropriate cluster config via helpers.getConfig().",
  "agents": [
    {
      "id": "junior-conductor",
      "role": "conductor",
      "modelLevel": "level1",
      "useDirectApi": true,
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "complexity": {
            "type": "string",
            "enum": ["TRIVIAL", "SIMPLE", "STANDARD", "CRITICAL", "UNCERTAIN"],
            "description": "Task complexity level"
          },
          "taskType": {
            "type": "string",
            "enum": ["INQUIRY", "TASK", "DEBUG"],
            "description": "Type of work: INQUIRY (questions/exploration), TASK (implement new), DEBUG (fix broken)"
          },
          "reasoning": {
            "type": "string",
            "description": "Why this classification (1-2 sentences)"
          }
        },
        "required": ["complexity", "taskType", "reasoning"]
      },
      "prompt": {
        "system": "You are the JUNIOR CONDUCTOR - fast task classification.\n\n## Your Job\nClassify the task on TWO dimensions.\n\n## COMPLEXITY (pick ONE)\n- TRIVIAL - One file, mechanical change; no behavior change.\n- SIMPLE - Small change, 1-2 files, low risk; does NOT touch auth/permissions, billing/payments, secrets/credentials, data integrity, infra/deploy/prod config, security/PII/compliance, or availability/SLOs.\n- STANDARD - Multi-file work or user-visible behavior; still avoids CRITICAL domains above.\n- CRITICAL - Any change or action that touches: auth/permissions, billing/payments, secrets/credentials, data migrations/destructive ops, security/PII/compliance, infra/deploy/prod config, or availability/SLO impact.\n- UNCERTAIN - Escalate to senior conductor.\nIf any CRITICAL trigger is present, choose CRITICAL. If unsure, go one level higher.\n\n## TASK TYPE (pick ONE)\n- INQUIRY - Questions, exploration, read-only\n- TASK - Implement something new\n- DEBUG - Fix something broken\n\n## Examples\n\nTask: \"Explain current auth flow (read-only)\"\n```json\n{\"complexity\": \"SIMPLE\", \"taskType\": \"INQUIRY\", \"reasoning\": \"Read-only explanation\"}\n```\n\nTask: \"Add rate limiting\"\n```json\n{\"complexity\": \"STANDARD\", \"taskType\": \"TASK\", \"reasoning\": \"New feature, multiple files\"}\n```\n\nTask: \"Fix null pointer bug\"\n```json\n{\"complexity\": \"SIMPLE\", \"taskType\": \"DEBUG\", \"reasoning\": \"Fixing broken code\"}\n```\n\nTask: \"Update billing webhook handler\"\n```json\n{\"complexity\": \"CRITICAL\", \"taskType\": \"TASK\", \"reasoning\": \"Billing/payments logic\"}\n```\n\nTask: \"Rotate production API keys\"\n```json\n{\"complexity\": \"CRITICAL\", \"taskType\": \"TASK\", \"reasoning\": \"Secrets/credentials\"}\n```\n\nTask: \"UI text tweak on settings page\"\n```json\n{\"complexity\": \"TRIVIAL\", \"taskType\": \"TASK\", \"reasoning\": \"Mechanical, one file\"}\n```\n\n## IMPORTANT: NOT CRITICAL (Common False Positives)\n\nThese are NOT CRITICAL even if they mention config/deployment/infrastructure:\n\nTask: \"Refactor to use dependency injection pattern\"\n```json\n{\"complexity\": \"STANDARD\", \"taskType\": \"TASK\", \"reasoning\": \"Code architecture refactor, not actual infra\"}\n```\n\nTask: \"Extract service configuration into separate module\"\n```json\n{\"complexity\": \"STANDARD\", \"taskType\": \"TASK\", \"reasoning\": \"Code organization, not production config\"}\n```\n\nTask: \"Implement factory pattern for executor creation\"\n```json\n{\"complexity\": \"STANDARD\", \"taskType\": \"TASK\", \"reasoning\": \"Design pattern refactor, internal code\"}\n```\n\nTask: \"Add deployment type discriminated union for type safety\"\n```json\n{\"complexity\": \"STANDARD\", \"taskType\": \"TASK\", \"reasoning\": \"TypeScript types, not actual deployment\"}\n```\n\nCRITICAL is ONLY for: actual auth logic, real billing code, production secrets, live infrastructure, real database migrations. Code refactoring that mentions these words is NOT CRITICAL.\n\n## Critical Rules\n1. Output ONLY valid JSON - no other text\n2. complexity must be EXACTLY one of: TRIVIAL, SIMPLE, STANDARD, CRITICAL, UNCERTAIN\n3. taskType must be EXACTLY one of: INQUIRY, TASK, DEBUG\n\nTask: {{ISSUE_OPENED.content.text}}"
      },
      "contextStrategy": {
        "sources": [{ "topic": "ISSUE_OPENED", "limit": 1 }],
        "format": "chronological",
        "maxTokens": 100000
      },
      "triggers": [
        {
          "topic": "ISSUE_OPENED",
          "logic": {
            "engine": "javascript",
            "script": "return message.sender === 'system' && !message.metadata?._republished;"
          },
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "transform": {
            "engine": "javascript",
            "script": "const { complexity, taskType, reasoning } = result;\nconst taskText = triggeringMessage.content?.text || '';\n\nif (complexity === 'UNCERTAIN') {\n  return {\n    topic: 'CONDUCTOR_ESCALATE',\n    content: {\n      text: reasoning,\n      data: { complexity, taskType, reasoning, taskText }\n    }\n  };\n}\n\nconst config = helpers.getConfig(complexity, taskType);\n\nreturn {\n  topic: 'CLUSTER_OPERATIONS',\n  content: {\n    text: `[${complexity}:${taskType}] ${reasoning}`,\n    data: {\n      complexity,\n      taskType,\n      operations: [\n        { action: 'load_config', config },\n        { action: 'publish', topic: 'ISSUE_OPENED', content: { text: taskText }, metadata: { _republished: true } }\n      ]\n    }\n  }\n};"
          }
        }
      }
    },
    {
      "id": "senior-conductor",
      "role": "conductor",
      "modelLevel": "level2",
      "useDirectApi": true,
      "outputFormat": "json",
      "jsonSchema": {
        "type": "object",
        "properties": {
          "complexity": {
            "type": "string",
            "enum": ["TRIVIAL", "SIMPLE", "STANDARD", "CRITICAL"],
            "description": "Task complexity (no UNCERTAIN - must decide)"
          },
          "taskType": {
            "type": "string",
            "enum": ["INQUIRY", "TASK", "DEBUG"],
            "description": "Type of work after analysis"
          },
          "reasoning": {
            "type": "string",
            "description": "Detailed explanation"
          }
        },
        "required": ["complexity", "taskType", "reasoning"]
      },
      "prompt": {
        "system": "You are the SENIOR CONDUCTOR - expert task analyzer.\n\nThe junior conductor was uncertain. Make a definitive classification.\n\n## COMPLEXITY (pick ONE - no UNCERTAIN allowed)\n- TRIVIAL - One file, mechanical change; no behavior change.\n- SIMPLE - Small change, 1-2 files, low risk; does NOT touch auth/permissions, billing/payments, secrets/credentials, data integrity, infra/deploy/prod config, security/PII/compliance, or availability/SLOs.\n- STANDARD - Multi-file work or user-visible behavior; still avoids CRITICAL domains above.\n- CRITICAL - Any change or action that touches: auth/permissions, billing/payments, secrets/credentials, data migrations/destructive ops, security/PII/compliance, infra/deploy/prod config, or availability/SLO impact.\nIf any CRITICAL trigger is present, choose CRITICAL. If unsure, go one level higher.\n\n## TASK TYPE (pick ONE)\n- INQUIRY - Questions, exploration (read-only)\n- TASK - Implement something new\n- DEBUG - Fix something broken\n\n## Example Output\n```json\n{\"complexity\": \"STANDARD\", \"taskType\": \"TASK\", \"reasoning\": \"Multiple files involved, new feature\"}\n```\n\n## Edge Examples\n\nTask: \"Rotate production API keys\"\n```json\n{\"complexity\": \"CRITICAL\", \"taskType\": \"TASK\", \"reasoning\": \"Secrets/credentials\"}\n```\n\nTask: \"UI text tweak on settings page\"\n```json\n{\"complexity\": \"TRIVIAL\", \"taskType\": \"TASK\", \"reasoning\": \"Mechanical, one file\"}\n```\n\nTask: \"Explain current auth flow (read-only)\"\n```json\n{\"complexity\": \"SIMPLE\", \"taskType\": \"INQUIRY\", \"reasoning\": \"Read-only explanation\"}\n```\n\n## NOT CRITICAL (Common False Positives)\n\nTask: \"Refactor to use dependency injection\"\n```json\n{\"complexity\": \"STANDARD\", \"taskType\": \"TASK\", \"reasoning\": \"Code architecture, not actual infra\"}\n```\n\nTask: \"Add deployment type discriminated union\"\n```json\n{\"complexity\": \"STANDARD\", \"taskType\": \"TASK\", \"reasoning\": \"TypeScript types, not real deployment\"}\n```\n\nCRITICAL = actual auth/billing/secrets/infra code. Refactoring that mentions these words is NOT CRITICAL.\n\n## Rules\n1. Output ONLY valid JSON - no other text\n2. YOU MUST DECIDE - pick exactly one value for each field\n3. When in doubt, go ONE LEVEL HIGHER for complexity\n\nJunior was uncertain. Original task follows."
      },
      "contextStrategy": {
        "sources": [
          { "topic": "ISSUE_OPENED", "limit": 1 },
          {
            "topic": "CONDUCTOR_ESCALATE",
            "since": "last_agent_start",
            "limit": 1
          },
          {
            "topic": "CLUSTER_OPERATIONS_VALIDATION_FAILED",
            "since": "cluster_start",
            "limit": 3
          }
        ],
        "format": "chronological",
        "maxTokens": 100000
      },
      "maxRetries": 3,
      "triggers": [
        { "topic": "CONDUCTOR_ESCALATE", "action": "execute_task" },
        {
          "topic": "CLUSTER_OPERATIONS_VALIDATION_FAILED",
          "action": "execute_task"
        }
      ],
      "hooks": {
        "onComplete": {
          "action": "publish_message",
          "transform": {
            "engine": "javascript",
            "script": "const { complexity, taskType, reasoning } = result;\n\nlet taskText = triggeringMessage.content?.data?.taskText || '';\nif (!taskText) {\n  taskText = triggeringMessage.content?.text || '';\n}\n\nconst config = helpers.getConfig(complexity, taskType);\n\nreturn {\n  topic: 'CLUSTER_OPERATIONS',\n  content: {\n    text: `Senior: [${complexity}:${taskType}] ${reasoning}`,\n    data: {\n      complexity,\n      taskType,\n      operations: [\n        { action: 'load_config', config },\n        { action: 'publish', topic: 'ISSUE_OPENED', content: { text: taskText }, metadata: { _republished: true } }\n      ]\n    }\n  }\n};"
          }
        }
      }
    }
  ]
}
